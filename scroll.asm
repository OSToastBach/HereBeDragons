patchline
        lda #$80
        sta $600
        sta $5FF
        ldx #$400
        ;lda #$80
patchloop
        sta ,x
        leax 32,x
        cmpx #$600
        bne patchloop
        rts

scrollseg
        ldx #$5E0
scrollseglp1
        lda scrollpal,y
        cmpa #0
        beq scrollsegend
        sta ,x+
scrollsegend
        rts


scrollcopy
        ldx #$3FF
scrollcopylp
        leax 2,x
        lda ,x
        leax -1,x
        sta ,x
        cmpx #$5FF
        bne scrollcopylp
        rts

loadcharseg
        clr ycnt
        ldx charaddr
        ldy #$480
loadcharseglp1
        lda ,x+
        sta ,y
        leay 32,y
        inc ycnt
        lda ycnt
        cmpa #8
        bne loadcharseglp1
        rts

calcletter
        ldy charindex
        lda string,y
        ;deca
        sty charindex
        ;lda [currstring]
        ;lda #1
        cmpa #0
        beq calcletterzero
        cmpa #44
        bne skipcalcreset
        ldy charindex
        leay 1,y
        sty charindex
        inc sceneval
        inc scrolltextval
        clr vscnt
        ;bra skipcalcreset
;skippause
        ;cmpa #45
        ;bne skipcalcreset
        ;ldy #$0000
        ;sty charindex
skipcalcreset
        ldx #chartable
        ldy charindex
        lda string,y
        ;ldd currstring
        ;addd charindex
        ;std currstring
        ;lda [currstring]
        ;lda #1
        sta letteraddcnt
calcletterlp1
        dec letteraddcnt
        leax 72,x
        lda letteraddcnt
        cmpa #0
        bne calcletterlp1
        stx charaddr
        bra calcletterend
calcletterzero
        ldx #chartable
        stx charaddr
calcletterend
        rts

scrollmain
        lda scrollflag1
        cmpa #0
        beq doscroll
        jsr scrollinit
        clr scrollflag1
doscroll
        lda lettercnt
        cmpa #0
        bne skipvsrst
        lda #9
        sta lettercnt
        ldy charindex
        leay 1,y
        sty charindex
        jsr calcletter
skipvsrst
        ;jsr scrollcopy
        jsr loadcharseg
        jsr scrollcopy
        jsr patchline

        ldx charaddr
        leax 8,x
        stx charaddr

        dec lettercnt

        ldx charaddr
        cmpx #chartableend
        bne skipcharrst
        ldx #chartable
        stx charaddr
skipcharrst
        ;sta letteraddcnt
        ;jsr scrollseg
        rts

;chars
        ;+0:    light green
        ;+16:   yellow
        ;+32:   blue
        ;+48:   red
        ;+64:   white
        ;+80:   dark green
        ;+96:   pink
        ;+112:  orange

chartable
        ;72 bytes per char
        ;8 bytes per column
        ;9 bytes per row
char_a
        fcb 128,183,255,243,159,159,207,207,179,191,255,243,159,159,207,207,191,191,255,243,159,159,207,207,191,191,255,128,128,159,207,128,191,191,255,245,149,149,197,197,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,207,128,186,255,255,159,159,207,207,128,128,128,128,128,128,128,128
char_b
        fcb 191,191,255,243,159,159,207,207,191,191,255,243,159,159,207,207,191,191,255,243,159,159,207,207,191,191,255,128,128,128,207,207,191,191,255,245,149,149,207,207,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,204,128,186,255,248,146,159,202,128,128,128,128,128,128,128,128,128
char_c
        fcb 191,191,255,243,159,159,207,207,191,191,255,243,159,159,207,207,191,191,255,243,159,159,207,207,191,191,255,128,128,159,207,207,191,191,255,128,128,159,207,207,191,191,255,128,128,159,207,207,179,191,255,128,128,159,207,204,128,186,255,128,128,159,202,128,128,128,128,128,128,128,128,128
char_d
        fcb 191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,207,191,191,128,128,128,128,207,207,191,191,245,245,149,149,207,207,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,204,128,186,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_e
        fcb 191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,241,148,159,207,207,191,191,255,243,156,159,207,207,191,191,255,243,156,159,207,207,179,191,255,243,156,159,207,204,128,186,255,243,156,159,202,128,128,128,128,128,128,128,128,128
char_f
        fcb 191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,241,148,128,128,128,191,191,255,243,156,128,128,128,191,191,255,243,156,128,128,128,179,191,255,243,156,128,128,128,128,186,255,243,156,128,128,128,128,128,128,128,128,128,128,128
char_g
        fcb 191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,128,128,128,207,207,191,191,255,243,159,159,207,207,191,191,255,243,159,159,207,207,179,191,255,243,159,159,207,204,128,186,255,243,159,159,202,128,128,128,128,128,128,128,128,128
char_h
        fcb 191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,187,191,255,255,159,159,207,206,128,128,243,255,128,128,128,128,128,128,243,255,128,128,128,128,183,191,255,255,159,159,207,205,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,128,128,128,128,128,128,128,128
char_i
        fcb 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,206,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_j
        fcb 128,128,128,128,128,147,197,128,128,128,128,128,128,147,207,204,128,128,128,128,128,147,207,207,128,128,128,128,128,147,207,207,181,181,241,245,149,151,207,207,191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,204,187,191,243,255,159,159,202,128,128,128,128,128,128,128,128,128
char_k
        fcb 191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,178,186,250,250,154,154,202,200,181,181,245,244,145,149,197,197,191,191,255,252,147,159,207,207,191,191,255,128,128,159,207,207,191,190,248,128,128,146,203,207,128,128,128,128,128,128,128,128
char_l
        fcb 191,191,255,255,159,159,197,128,191,191,255,255,159,159,207,204,191,191,255,255,159,159,207,207,128,128,128,128,128,147,207,207,128,128,128,128,128,147,207,207,128,128,128,128,128,147,207,207,128,128,128,128,128,147,207,204,128,128,128,128,128,147,202,128,128,128,128,128,128,128,128,128
char_m
        fcb 191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,245,149,149,197,197,191,191,252,250,154,154,202,202,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,207,128,186,255,255,159,159,207,207,128,128,128,128,128,128,128,128
char_n
        fcb 191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,128,128,128,128,128,191,191,252,128,128,128,128,128,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,207,128,186,255,255,159,159,207,207,128,128,128,128,128,128,128,128
char_o
        fcb 128,181,252,255,159,159,197,128,179,191,252,255,159,159,207,204,191,191,252,255,159,159,207,207,191,191,252,128,128,128,207,207,191,191,252,128,128,128,207,207,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,204,128,186,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_p
        fcb 191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,128,128,128,128,128,191,191,252,255,159,128,128,128,191,191,255,255,159,128,128,128,179,191,255,255,159,128,128,128,128,186,255,255,159,128,128,128,128,128,128,128,128,128,128,128
char_q
        fcb 128,181,252,255,159,159,197,128,179,191,252,255,159,159,207,204,191,191,252,255,159,159,207,207,191,191,252,128,128,128,207,207,191,191,252,128,128,128,202,202,191,191,255,255,159,159,207,205,179,191,255,255,159,159,207,207,128,186,255,255,159,159,207,207,128,128,128,128,128,128,128,128
char_r
        fcb 191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,255,159,159,207,207,191,191,252,128,128,128,128,128,191,191,252,255,159,128,128,128,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,207,128,186,255,255,159,155,207,207,128,128,128,128,128,128,128,128
char_s
        fcb 191,191,252,252,128,147,197,128,191,191,252,255,128,147,207,204,191,191,252,255,156,147,207,207,191,191,252,255,159,147,207,207,191,191,252,255,159,147,207,207,191,191,252,243,159,147,207,207,179,191,252,128,159,147,207,207,128,186,252,128,147,147,207,207,128,128,128,128,128,128,128,128
char_t
        fcb 191,191,252,128,128,128,128,128,191,191,252,128,128,128,128,128,191,191,252,128,128,128,128,128,191,191,252,128,128,128,128,128,191,191,252,128,128,128,128,128,191,191,255,255,159,159,207,207,179,191,255,255,159,159,207,207,128,186,255,255,159,159,207,207,128,128,128,128,128,128,128,128
char_u
        fcb 191,191,255,255,159,159,197,128,191,191,255,255,159,159,207,204,191,191,255,255,159,159,207,207,128,128,128,128,128,128,197,197,128,128,128,128,128,128,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,204,191,191,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_v
        fcb 191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,207,128,128,128,128,128,128,197,197,128,128,128,128,128,128,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,204,191,191,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_w
        fcb 191,191,255,255,159,159,197,128,191,191,255,255,159,159,207,204,191,191,255,255,159,159,207,207,181,181,245,245,149,148,207,207,186,186,250,250,154,152,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,204,191,191,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_x
        fcb 191,191,253,128,128,151,207,207,191,191,255,252,147,159,207,207,191,191,255,252,147,159,207,207,186,186,250,248,146,154,202,202,181,181,245,244,145,149,197,197,191,191,255,252,147,159,207,207,191,191,255,252,147,159,207,207,191,191,254,128,128,155,207,207,128,128,128,128,128,128,128,128
char_y
        fcb 191,191,253,244,128,159,207,207,191,191,255,255,128,159,207,207,191,191,255,255,156,159,207,207,128,128,255,255,156,159,207,207,128,128,250,250,152,159,207,207,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,204,191,191,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_z
        fcb 128,181,252,128,147,147,207,207,179,191,252,128,159,147,207,207,191,191,252,243,159,147,207,207,191,191,252,255,159,147,207,207,191,191,252,255,159,147,207,207,191,191,252,255,156,147,207,207,191,191,252,255,128,147,207,204,191,191,252,252,128,147,202,128,128,128,128,128,128,128,128,128
char_dash
        fcb 128,128,241,245,148,128,128,128,128,128,243,255,156,128,128,128,128,128,243,255,156,128,128,128,128,128,243,255,156,128,128,128,128,128,243,255,156,128,128,128,128,128,243,255,156,128,128,128,128,128,243,255,156,128,128,128,128,128,242,250,152,128,128,128,128,128,128,128,128,128,128,128
char_exclamation
        fcb 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,191,191,255,255,159,156,207,207,191,191,255,255,159,156,207,207,191,191,255,255,159,156,207,207,191,191,255,255,159,156,207,206,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_question
        fcb 128,181,128,128,128,128,128,128,179,191,128,128,128,128,128,128,191,191,241,245,149,149,193,197,191,191,243,255,159,159,195,207,191,191,243,255,159,159,195,207,191,191,243,255,154,154,194,200,179,191,255,255,128,128,128,128,128,186,255,254,128,128,128,128,128,128,128,128,128,128,128,128
char_fullstop
        fcb 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,197,128,128,128,128,128,128,128,202,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_circumflex
        fcb 128,188,128,247,147,159,197,128,179,188,243,255,147,159,207,204,191,128,255,255,147,159,207,207,191,128,255,255,128,128,195,207,191,128,255,255,128,128,195,207,191,128,255,255,159,159,207,207,179,188,243,255,159,159,207,204,128,188,128,250,159,159,202,128,128,128,128,128,128,128,128,128
char_space
        fcb 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_apostrophe
        fcb 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,181,180,128,128,128,128,128,128,186,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_comma
        fcb 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,193,199,128,128,128,128,128,128,194,200,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_zero
        fcb 128,181,252,255,159,159,207,196,179,191,252,255,159,159,207,207,191,191,252,250,154,159,207,207,191,191,252,128,151,158,207,207,191,191,252,247,158,128,207,207,191,191,255,255,149,149,207,207,179,191,255,255,159,159,207,207,128,186,255,255,159,159,207,200,128,128,128,128,128,128,128,128
char_one
        fcb 128,181,128,128,128,128,128,128,179,191,128,128,128,128,128,128,191,191,241,245,149,149,197,197,191,191,243,255,159,159,207,207,191,191,243,255,159,159,207,207,186,186,242,250,154,154,202,202,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
char_two
        fcb 128,183,128,241,156,159,207,205,179,191,241,255,156,159,207,207,191,191,243,255,156,128,207,207,191,191,243,255,156,128,207,207,191,191,243,255,156,128,207,207,191,191,243,255,156,128,207,207,191,191,243,255,152,128,207,207,191,191,243,248,128,128,207,207,128,128,128,128,128,128,128,128
char_three
        fcb 191,191,252,128,128,159,207,207,191,191,252,128,128,159,207,207,191,191,252,245,148,159,207,207,191,191,252,255,156,159,207,207,191,191,252,255,156,159,207,207,191,191,252,255,156,159,207,207,187,191,252,255,156,159,207,206,128,187,252,255,156,159,206,128,128,128,128,128,128,128,128,128
char_four
        fcb 191,191,253,244,128,128,128,128,191,191,255,255,128,128,128,128,191,191,255,255,156,128,128,128,128,128,255,255,156,128,128,128,128,128,250,250,152,128,128,128,191,191,255,255,159,159,207,207,191,191,255,255,159,159,207,204,191,191,255,255,159,159,202,128,128,128,128,128,128,128,128,128
char_five
        fcb 191,191,252,255,159,128,207,196,191,191,252,255,159,128,207,205,191,191,252,250,159,128,207,207,191,191,252,128,159,128,207,207,191,191,252,128,159,128,207,207,191,191,252,128,159,149,207,207,179,191,252,128,159,159,207,207,128,186,252,128,159,159,207,206,128,128,128,128,128,128,128,128
char_six
        fcb 191,191,252,255,159,159,207,196,191,191,252,255,159,159,207,207,191,191,252,250,159,154,207,207,191,191,252,128,159,128,207,207,191,191,252,128,159,128,207,207,191,191,252,128,159,149,207,207,179,191,252,128,159,159,207,207,128,186,252,128,159,159,207,200,128,128,128,128,128,128,128,128
char_seven
        fcb 191,191,252,128,128,128,128,128,191,191,252,128,128,128,128,128,191,191,252,128,128,149,197,197,191,191,252,128,151,159,207,207,191,191,252,247,159,159,207,207,191,191,255,255,159,154,202,202,179,191,255,255,152,128,128,128,128,186,255,248,128,128,128,128,128,128,128,128,128,128,128,128
char_eight
        fcb 128,181,252,255,159,159,207,196,179,191,252,255,159,159,207,207,191,191,252,250,159,154,207,207,191,191,252,128,159,128,207,207,191,191,252,128,159,128,207,207,191,191,252,245,159,149,207,207,179,191,252,255,159,159,207,207,128,186,252,255,159,159,207,200,128,128,128,128,128,128,128,128
char_nine
        fcb 128,181,252,255,159,147,207,196,179,191,252,255,159,147,207,207,191,191,252,250,159,146,207,207,191,191,252,128,159,128,207,207,191,191,252,128,159,128,207,207,191,191,252,245,159,149,207,207,179,191,252,255,159,159,207,207,128,186,252,255,159,159,207,200,128,128,128,128,128,128,128,128

chartableend

string          ;pad first character, 44 for next scene
        fcb 0,31,31,31,31,7,4,11,11,14,31,13,14,21,0,27,27,31,31,31,31,18,11,8,15,18,19,17,4,0,12,31,7,4,17,4,31,22,8,19,7,31,0,31,1,17,0,13,3,31,18,15,0,13,10,8,13,32,31,13,4,22,31,3,4,12,14,31,5,14,17,31,19,7,4,31,12,8,6,7,19,24,31,22,4,11,18,7,31,12,8,2,17,14,33,31,19,7,4,31,3,17,0,6,14,13,31,37,36,27,31,31,31,31,31,31,1,20,19,31,22,7,0,19,32,18,31,8,13,31,0,31,3,17,0,6,14,13,28,31,31,31,31,31,31,44
        fcb 31,31,31,31,22,7,24,31,13,14,19,31,22,4,31,18,4,4,31,22,7,0,19,31,22,4,31,2,0,13,31,3,14,31,22,8,19,7,31,8,19,29,29,29,31,31,11,4,19,32,18,31,6,4,19,31,18,14,12,4,31,14,11,3,18,10,14,14,11,31,0,2,19,8,14,13,31,6,14,8,13,6,27,27,31,31,31,31,31,31,44
        fcb 31,31,31,31,22,0,18,13,32,19,31,19,7,0,19,31,2,14,14,11,28,28,31,31,31,22,4,32,21,4,31,13,14,19,31,18,4,4,13,31,12,14,17,4,31,19,7,0,13,31,38,31,2,14,11,14,20,17,18,31,18,14,31,5,0,17,31,7,0,21,4,31,22,4,29,29,29,31,31,31,11,4,19,32,18,31,2,7,0,13,6,4,31,19,7,0,19,27,31,31,31,31,31,31,31,31,31,44
        fcb 31,31,31,31,2,0,13,31,24,14,20,17,31,1,1,2,31,12,8,2,17,14,31,3,14,31,19,7,0,19,28,31,7,0,7,0,29,29,29,31,31,9,10,29,29,29,31,31,31,14,7,31,24,4,0,7,33,31,7,4,17,4,32,18,31,14,20,17,31,4,13,19,17,24,31,5,14,17,31,19,7,4,31,17,14,19,0,19,8,13,6,31,18,7,4,4,15,31,2,14,12,15,14,27,31,31,31,31,31,44

scrollpal
        fcb 128,128,32,191,255,96,159,207,207,159,96,255,191,32,128,128,0